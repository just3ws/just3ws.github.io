#!/usr/bin/env ruby
require 'yaml'
require 'date'

ROOT = File.expand_path('..', __dir__)

def load_yaml(path, key)
  data = YAML.safe_load(File.read(path), permitted_classes: [Date, Time], aliases: true) || {}
  data[key] || []
end

def slugify(value)
  value.to_s.downcase
       .gsub(/[^a-z0-9]+/, '-')
       .gsub(/\A-+|-+\z/, '')
end

def find_case_insensitive_duplicates(records, key)
  groups = Hash.new { |h, k| h[k] = [] }
  records.each do |record|
    value = record[key]
    next if value.nil? || value.to_s.strip.empty?
    groups[value.to_s.downcase] << value.to_s
  end
  groups.select { |_k, values| values.size > 1 }
end

def find_slug_collisions(records, value_key:, id_key:)
  groups = Hash.new { |h, k| h[k] = [] }
  records.each do |record|
    slug = slugify(record[value_key])
    next if slug.empty?
    groups[slug] << record[id_key]
  end
  groups.select { |_slug, ids| ids.uniq.size > 1 }
end

errors = []

interviews = load_yaml(File.join(ROOT, '_data', 'interviews.yml'), 'items')
assets = load_yaml(File.join(ROOT, '_data', 'video_assets.yml'), 'items')
conferences = load_yaml(File.join(ROOT, '_data', 'interview_conferences.yml'), 'conferences')
communities = load_yaml(File.join(ROOT, '_data', 'interview_communities.yml'), 'communities')

{
  'interview id' => [interviews, 'id'],
  'video asset id' => [assets, 'id'],
  'conference slug' => [conferences, 'slug'],
  'community slug' => [communities, 'slug']
}.each do |label, (records, key)|
  duplicates = find_case_insensitive_duplicates(records, key)
  duplicates.each do |normalized, values|
    errors << "#{label} duplicate (case-insensitive): #{normalized} (#{values.join(', ')})"
  end
end

{
  'interview generated slug from id' => [interviews, 'id', 'id'],
  'video asset generated slug from id' => [assets, 'id', 'id']
}.each do |label, (records, value_key, id_key)|
  collisions = find_slug_collisions(records, value_key: value_key, id_key: id_key)
  collisions.each do |slug, ids|
    errors << "#{label} collision: #{slug} generated by #{ids.uniq.sort.join(', ')}"
  end
end

if errors.empty?
  puts 'Data dedupe validation passed.'
  exit 0
end

warn 'Data dedupe validation failed:'
errors.each { |error| warn "  - #{error}" }
exit 1
