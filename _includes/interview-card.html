{% assign asset = site.data.video_assets.items | where: "id", interview.video_asset_id | first %}
{% assign vimeo = asset.platforms | where: "platform", "vimeo" | first %}
{% assign youtube = asset.platforms | where: "platform", "youtube" | first %}
{% assign preferred = vimeo | default: youtube | default: asset.platforms.first %}
{% assign primary_url = "/interviews/" | append: interview.id | append: "/" %}
{% assign thumb = preferred.thumbnail_local | default: preferred.thumbnail | default: asset.thumbnail_local | default: asset.thumbnail %}
{% assign has_transcript = false %}
{% assign transcript_entry = nil %}
{% if asset and asset.transcript_id %}
  {% assign transcript_entry = site.data.transcripts[asset.transcript_id] %}
  {% if transcript_entry and transcript_entry.content %}
    {% assign has_transcript = true %}
  {% endif %}
{% endif %}

<div class="video{% if has_transcript %} has-transcript{% endif %}">
  {% if thumb %}
    <a class="video-thumb" href="{{ primary_url }}">
      <img src="{{ thumb }}" alt="Thumbnail for {{ interview.title }}">
    </a>
  {% endif %}
  <div class="video-body">
    <div class="video-title"><a href="{{ primary_url }}">{{ interview.title }}</a></div>
    {% if has_transcript %}
      <div class="video-indicators">
        <span class="video-indicator transcript" aria-label="Transcript available">★ Transcript Available</span>
      </div>
    {% endif %}
    {% if interview.interviewees and interview.interviewees.size > 0 %}
      <div class="video-subtitle">Interviewee{% if interview.interviewees.size > 1 %}s{% endif %}: {{ interview.interviewees | join: ", " }}</div>
    {% endif %}
    {% if interview.topic %}
      <div class="video-subtitle">Topic: {{ interview.topic }}</div>
    {% endif %}
    <div class="video-meta">
      {% if preferred.duration_minutes %}Duration: {{ preferred.duration_minutes | round }} min · {% endif %}{% if preferred.published_date %}Uploaded: {{ preferred.published_date | date: "%b %d, %Y" }}{% elsif asset.published_date %}Uploaded: {{ asset.published_date | date: "%b %d, %Y" }}{% endif %}
    </div>
    <div class="video-meta">
      {% if interview.conference %}
        Conference:
        {% assign conference_candidates = site.data.interview_conferences.conferences | where: "conference", interview.conference %}
        {% assign conference_entry = conference_candidates | where: "year", interview.conference_year | first %}
        {% if conference_entry %}
          <a href="/interviews/conferences/{{ conference_entry.slug }}/">{{ interview.conference }}{% if interview.conference_year %} {{ interview.conference_year }}{% endif %}</a>
        {% else %}
          {{ interview.conference }}{% if interview.conference_year %} {{ interview.conference_year }}{% endif %}
        {% endif %}
      {% endif %}
      {% if interview.community %}{% if interview.conference %} · {% endif %}Community: {{ interview.community }}{% endif %}
    </div>
    <div class="video-actions">
      <a class="video-button primary" href="{{ primary_url }}">View Interview</a>
      {% if asset.platforms and asset.platforms.size > 0 %}
        {% assign platforms = asset.platforms | sort: "platform" %}
        {% for platform in platforms %}
          {% if platform.url %}
            <a class="video-button" href="{{ platform.url }}">Watch on {{ platform.platform | capitalize }}</a>
          {% endif %}
        {% endfor %}
      {% elsif preferred and preferred.url %}
        <a class="video-button" href="{{ preferred.url }}">Watch on {{ preferred.platform | capitalize }}</a>
      {% endif %}
    </div>
    {% if asset.tags and asset.tags.size > 0 %}
      <div class="video-tags">
        {% for tag in asset.tags %}
          <span class="tag">{{ tag }}</span>
        {% endfor %}
      </div>
    {% endif %}
    {% if asset.description %}
      <div class="video-description"><span class="video-description-label">Video description:</span> {{ asset.description }}</div>
    {% endif %}
  </div>
</div>
